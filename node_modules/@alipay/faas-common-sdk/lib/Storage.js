"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Storage=void 0;const error_1=require("./error"),utils_1=require("./utils");class Storage{#t;constructor(t){this.#t=t}#i(t){return`/${t}?upload_url`}#n(t){return`/${t}?download_url&expire=3600`}#a(){return"/?delete"}#l(){return"/?download_url"}#h(t){if(typeof t!="string")return"\u5FC5\u987B\u4E3A\u5B57\u7B26\u4E32";if(t=t.trim(),!t)return"\u4E0D\u80FD\u4E3A\u7A7A\u5B57\u7B26\u4E32";if(t.startsWith("/"))return"\u4E0D\u80FD\u4EE5 / \u5F00\u5934";if(t.includes("//"))return"\u4E0D\u80FD\u5305\u542B\u8FDE\u7EED\u7684 /";if(t.length>850)return"\u957F\u5EA6\u4E0D\u80FD\u8D85\u8FC7 850 \u5B57\u8282"}#s(t){if(typeof t!="string")return"\u5FC5\u987B\u4E3A\u5B57\u7B26\u4E32";if(t=t.trim(),!t)return"\u4E0D\u80FD\u4E3A\u7A7A\u5B57\u7B26\u4E32"}#r(t){return`cloud://${this.#t.toEnvId}/${t.replace(/^\/+/,"")}`}#o(t){const s=t.trim().replace(/^cloud:\/\//,""),r=s.indexOf("/");if(r<=0)throw error_1.FaasError.INVALID_PARAM_ERR("fileID","\u4E0D\u5408\u6CD5");const o=s.substring(0,r),i=s.substring(r+1);return o!==this.#t.toEnvId&&console.warn(`file ${t} does not belong to env ${this.#t.toEnvId}`),i}async uploadFile(t){const s=this.#h(t.cloudPath);if(s)throw error_1.FaasError.INVALID_PARAM_ERR("cloudPath",s);const r=this.#i(t.cloudPath.trim()),o=await this.#e({method:"GET",path:r}),i=utils_1.ResponseUtil.handleResponse(o),n=this.#r(i.file_id),e=await this.#t.fileUploader.upload({fileID:n,uploadURL:i.upload_url,fileContent:t.fileContent});if(e.statusCode!==200)throw error_1.FaasError.STORAGE_ERR(-1,"\u6587\u4EF6\u4E0B\u8F7D\u5931\u8D25",o.requestID);return{fileID:n,statusCode:e.statusCode}}async downloadFile(t){const s=this.#s(t.fileID);if(s)throw error_1.FaasError.INVALID_PARAM_ERR("fileID",s);const r=this.#o(t.fileID),o=this.#n(r),i=await this.#e({method:"GET",path:o}),n=utils_1.ResponseUtil.handleResponse(i),e=await this.#t.fileUploader.download({fileID:t.fileID,downloadURL:n.download_url});if(e.statusCode!==200)throw error_1.FaasError.STORAGE_ERR(-1,"\u6587\u4EF6\u4E0B\u8F7D\u5931\u8D25",i.requestID);return e}async deleteFile(t){const s=Array.isArray(t)?t:t.fileList;if(!Array.isArray(s)||s.length===0)throw error_1.FaasError.INVALID_PARAM_ERR("fileList","\u4E0D\u80FD\u4E3A\u7A7A\u6570\u7EC4");const r=[];for(const e of s){const a=this.#s(e);if(a)throw error_1.FaasError.INVALID_PARAM_ERR("fileID",a);const l=this.#o(e);r.push(l)}const o=this.#a(),i=await this.#e({method:"POST",path:o,data:{file_list:r}});return{fileList:utils_1.ResponseUtil.handleResponse(i).file_list.map(e=>({fileID:this.#r(e.file_id),status:e.status?0:-1,errMsg:e.status?"ok":e.result_message}))}}async getTempFileURL(t){const s=Array.isArray(t)?t:t.fileList;if(!Array.isArray(s)||s.length===0)throw error_1.FaasError.INVALID_PARAM_ERR("fileList","\u4E0D\u80FD\u4E3A\u7A7A\u6570\u7EC4");if(s.length>50)throw error_1.FaasError.INVALID_PARAM_ERR("fileList","\u6700\u5927\u957F\u5EA6 50");const r=[];for(const e of s){const a=this.#s(e);if(a)throw error_1.FaasError.INVALID_PARAM_ERR("fileID",a);const l=this.#o(e);r.push({file_id:l,expire:600})}const o=this.#l(),i=await this.#e({method:"POST",path:o,data:{file_list:r}});return{fileList:utils_1.ResponseUtil.handleResponse(i).file_list.map(e=>({fileID:this.#r(e.file_id),tempFileURL:e.download_url,status:e.status?0:-1,errMsg:e.status?"ok":e.result_message}))}}async#e({method:t,path:s,data:r,headers:o}){return await this.#t.httpclient.request({method:t,path:s,data:r,headers:{"x-alipay-cloud-mode":"oss","x-data-api-type":"oss","x-expire-timestamp":`${Date.now()+6e4}`,...o}})}}exports.Storage=Storage;