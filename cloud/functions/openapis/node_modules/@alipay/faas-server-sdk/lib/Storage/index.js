"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Storage=void 0;const node_util_1=require("node:util"),urllib_1=require("urllib"),errors_1=require("../errors"),middlewares_1=require("../requester/middlewares"),debug=(0,node_util_1.debuglog)("faas-server-sdk:Storage");class Storage{#t;constructor(t){this.#t=t}#o(t){return`${this.#t.functionStorageEndpoint}/${t}?upload_url`}#i(t){return`${this.#t.functionStorageEndpoint}/${t}?download_url&expire=3600`}#n(){return`${this.#t.functionStorageEndpoint}/?delete`}#a(){return`${this.#t.functionStorageEndpoint}/?download_url`}#u(t){if(typeof t!="string")return"must be a string";if(t=t.trim(),!t)return"cannot be an empty string";if(t.startsWith("/"))return"cannot start with /";if(t.includes("//"))return"cannot appear consecutively /";if(t.length>850)return"maximum encoding length of 850 bytes"}#e(t){if(typeof t!="string")return"must be a string";if(t=t.trim(),!t)return"cannot be an empty string"}#r(t){return`cloud://${this.#t.toEnvId}/${t.replace(/^\/+/,"")}`}#s(t){const s=t.trim().replace(/^cloud:\/\//,""),n=s.indexOf("/");if(n<=0)throw errors_1.errors.INVALID_PARAM("fileID","is invalid");const r=s.substring(0,n),e=s.substring(n+1);return r!==this.#t.toEnvId&&console.warn(`file ${t} does not belong to env ${this.#t.toEnvId}`),e}async uploadFile(t){const s=this.#u(t.cloudPath);if(s)throw errors_1.errors.INVALID_PARAM("cloudPath",s);const n=this.#o(t.cloudPath.trim()),r=await middlewares_1.HttpRequester.storage.request("GET",n,"",{},{cloudConfig:this.#t});if(!r.succeed)throw errors_1.errors.CALL_STORAGE_ERR(r);const e=this.#r(r.data.file_id);let i=r.data.upload_url;process.env.NODE_ENV==="test"&&(i=i.replace("https://","http://"));let o,u;Buffer.isBuffer(t.fileContent)?u=t.fileContent:o=t.fileContent;const a=await(0,urllib_1.request)(i,{method:"PUT",content:u,stream:o,timeout:6e4});if(debug("uploadFile fileID: %o, uploadURL: %o got response status: %o, headers: %o, body: %o",e,i,a.status,a.headers,a.data.toString()),a.status!==200)throw errors_1.errors.CALL_STORAGE_ERR({succeed:!1,errMsg:"upload file to storage error",errCode:-1,requestId:r.requestId,status:a.status});return{fileID:e,statusCode:a.status}}async downloadFile(t){const s=this.#e(t.fileID);if(s)throw errors_1.errors.INVALID_PARAM("fileID",s);const n=this.#s(t.fileID),r=this.#i(n),e=await middlewares_1.HttpRequester.storage.request("GET",r,"",{},{cloudConfig:this.#t});if(!e.succeed)throw errors_1.errors.CALL_STORAGE_ERR(e);const i=e.data.download_url,o=await(0,urllib_1.request)(i,{timeout:6e4});if(debug("downloadFile fileID: %o, downloadURL: %o got response status: %o, headers: %o, body length: %o",t.fileID,i,o.status,o.headers,o.data.length),o.status!==200)throw errors_1.errors.CALL_STORAGE_ERR({succeed:!1,errMsg:"download file from storage error",errCode:-1,requestId:e.requestId,status:o.status});return{fileContent:o.data,statusCode:o.status}}async deleteFile(t){if(!Array.isArray(t)||t.length===0)throw errors_1.errors.INVALID_PARAM("fileList","cannot be an empty list");const s=[];for(const e of t){const i=this.#e(e);if(i)throw errors_1.errors.INVALID_PARAM("fileID",i);const o=this.#s(e);s.push(o)}const n=this.#n(),r=await middlewares_1.HttpRequester.storage.request("POST",n,{file_list:s},{},{cloudConfig:this.#t});if(!r.succeed)throw errors_1.errors.CALL_STORAGE_ERR(r);return{fileList:r.data.file_list.map(e=>({fileID:this.#r(e.file_id),status:e.status?0:-1,errMsg:e.status?"ok":e.result_message}))}}async getTempFileURL(t){if(!Array.isArray(t)||t.length===0)throw errors_1.errors.INVALID_PARAM("fileList","cannot be an empty list");if(t.length>50)throw errors_1.errors.INVALID_PARAM("fileList","Maximum 50 files");const s=[];for(const e of t){const i=this.#e(e);if(i)throw errors_1.errors.INVALID_PARAM("fileID",i);const o=this.#s(e);s.push({file_id:o,expire:600})}const n=this.#a(),r=await middlewares_1.HttpRequester.storage.request("POST",n,{file_list:s},{},{cloudConfig:this.#t});if(!r.succeed)throw errors_1.errors.CALL_STORAGE_ERR(r);return{fileList:r.data.file_list.map(e=>({fileID:this.#r(e.file_id),tempFileURL:e.download_url,status:e.status?0:-1,errMsg:e.status?"ok":e.result_message}))}}}exports.Storage=Storage;