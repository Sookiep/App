"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MySQL=void 0;const faas_server_utils_1=require("@alipay/faas-server-utils"),ali_rds_1=require("ali-rds");class MySQL{#t;#s;#n=!0;constructor(t){this.#t=t}async query(t,e){return await this.#e().query(t,e)}async insert(t,e,s){return await this.#e().insert(t,e,s)}async update(t,e,s){return await this.#e().update(t,e,s)}async select(t,e){return await this.#e().select(t,e)}async get(t,e,s){return await this.#e().get(t,e,s)}async delete(t,e){return await this.#e().delete(t,e)}#i(t=""){const e=(0,faas_server_utils_1.getAlipayContext)(),s=Date.now(),r={authorization:"","x-from-app-id":e.APPID,"x-from-env-id":this.#t.fromEnvId,"x-to-env-id":this.#t.toEnvId,"x-from-instance-id":this.#t.functionInstanceId,"x-from-function-name":this.#t.functionName,"x-client-timestamp":`${s}`,"x-trace-id":e.TRACEID},c=["x-from-app-id","x-from-env-id","x-to-env-id","x-from-instance-id","x-from-function-name","x-client-timestamp"],u={path:"",query:"",secretId:this.#t.secretId,secretKey:this.#t.secretKey,method:"POST",headers:r,body:t,timestamp:s,signedHeaders:c};r.authorization=(0,faas_server_utils_1.sign)(u);const a=[];for(const i in r){if(i==="authorization")continue;const n=r[i];a.push(`${i}:${n}`)}const o=r.authorization.split(" ");a.push(`SecAlgo:${o[0]}`);for(let i=1;i<o.length;i++){let n=o[i];n.endsWith(",")&&(n=n.substring(0,n.length-1)),a.push(n.replace(/=/g,":").replace(/,/g,";"))}return`!cloudbase:${a.join(",")}`}#e(){if(!this.#s){if(process.env.NODE_ENV==="test"){const t=process.env.MYSQL_USER==="integration";t||(this.#n=!1),this.#s=new ali_rds_1.RDSClient({host:process.env.MYSQL_HOST||"127.0.0.1",port:process.env.MYSQL_PORT||3306,user:t?this.#i():process.env.MYSQL_USER||"root",password:process.env.MYSQL_PASSWORD||"",database:process.env.MYSQL_DATABASE||"faas_unittest"})}else this.#s=new ali_rds_1.RDSClient({host:"127.0.0.1",port:11306,user:this.#i(),password:"",database:"my_cloud_db"});this.#s.beforeQuery(t=>this.#n?`/*${this.#i(t)}*/${t}`:t)}return this.#s}}exports.MySQL=MySQL;