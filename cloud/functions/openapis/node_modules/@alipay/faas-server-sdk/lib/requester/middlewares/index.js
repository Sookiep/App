"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HttpRequester=void 0;const node_assert_1=__importDefault(require("node:assert")),node_crypto_1=require("node:crypto"),koa_compose_1=__importDefault(require("koa-compose")),call_openapi_middleware_1=require("./call_openapi_middleware"),HttpRequestContext_1=require("./HttpRequestContext"),call_database_middleware_1=require("./call_database_middleware"),call_function_middleware_1=require("./call_function_middleware"),call_middleware_1=require("./call_middleware"),sign_middleware_factory_1=require("./sign_middleware_factory"),init_call_dataproxy_headers_middleware_1=require("./init_call_dataproxy_headers_middleware"),error_handler_middleware_1=require("./error_handler_middleware");class HttpRequester{static#e;static#t;static#a;static#r;#i;constructor(e){this.#i=(0,koa_compose_1.default)(e)}async request(e,d,s,a,n){const r=n.cloudConfig;(0,node_assert_1.default)(r,"cloud config not set");const l=JSON.stringify(s),o=(0,node_crypto_1.randomUUID)();a["x-request-id"]=o;const c={method:e,contentType:"application/json",content:l,dataType:"json",headers:a},_={url:new URL(d),requestOptions:c},i=new HttpRequestContext_1.HttpRequestContext(_,r);return await this.#i(i),i.result}static get function(){if(!this.#e){const e=[error_handler_middleware_1.errorHandlerMiddleware,(0,sign_middleware_factory_1.signMiddlewareFactory)(["x-to-function-name"]),call_function_middleware_1.callFunctionMiddleware,call_middleware_1.callMiddleware];this.#e=new HttpRequester(e)}return this.#e}static get database(){if(!this.#t){const e=[error_handler_middleware_1.errorHandlerMiddleware,(0,init_call_dataproxy_headers_middleware_1.createInitCallDataProxyHeadersMiddleware)("mongo"),(0,sign_middleware_factory_1.signMiddlewareFactory)(["x-data-api-type","x-expire-timestamp"]),call_database_middleware_1.callDatabaseMiddleware,call_middleware_1.callMiddleware];this.#t=new HttpRequester(e)}return this.#t}static get storage(){if(!this.#a){const e=[error_handler_middleware_1.errorHandlerMiddleware,(0,init_call_dataproxy_headers_middleware_1.createInitCallDataProxyHeadersMiddleware)("oss"),(0,sign_middleware_factory_1.signMiddlewareFactory)(["x-data-api-type","x-expire-timestamp"]),call_database_middleware_1.callDatabaseMiddleware,call_middleware_1.callMiddleware];this.#a=new HttpRequester(e)}return this.#a}static get openapi(){if(!this.#r){const e=[error_handler_middleware_1.errorHandlerMiddleware,(0,sign_middleware_factory_1.signMiddlewareFactory)(["x-openapi","x-openapi-version"]),call_openapi_middleware_1.callOpenapiMiddleware,call_middleware_1.callMiddleware];this.#r=new HttpRequester(e)}return this.#r}}exports.HttpRequester=HttpRequester;